**手游《战双帕弥什》的核心技术分享**
=================

(Github正常排版: [手游《战双帕弥什》的核心技术分享](https://github.com/HHHHHHHHHHHHHHHHHHHHHCS/MyStudyNote/MyUWA2020Note/blob/main/%E6%89%8B%E6%B8%B8%E3%80%8A%E6%88%98%E5%8F%8C%E5%B8%95%E5%BC%A5%E4%BB%80%E3%80%8B%E7%9A%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB.md))

------------------------

[1. 安全与公平](#1)<br>
[2. 游戏体验](#2)<br>
[3. 粒子优化](#3)<br>
[4. 粒子离线模拟](#4)<br>

------------------------
<span id='1'/>

## **1. 安全与公平**
1. ## **包体加固**
    + 二次打包 -> 可以用自定义的SDK去替换官方的SDK和入口
    + 反编译 -> 关键的逻辑被替换
    + so dll替换 -> 腾讯包加固 , 网易包加固
<br/>

2. ## **外挂**
    + 加速器 -> 对时间相关的函数进行封装
    + 修改器 -> 内存的变量做校验 , 偏移 , 组合
       - 葫芦,烧饼,GG,八门神器
    + 虚拟器 -> 比模拟器更灵活,对游戏更方便调试
    + 运行时候调试
       - GDB,IDA -> 把一些入口方法修改替换
<br/>

3. ## **协议加密**
    + 初始号
    + 脱机
    + 黑产
<br/>

4. ## **包内容加密**
    + AssetBundle加密
      - 定期更换密钥
      - Unity中国版加密
    + 重要文件签名 -- 非对称加密
      - 打包 -> 获取文本内容 -> 计算内容的Hash -> 私钥签名Hash -> Hash加到头部做偏移 -> 生成TextAsset
      - 解包 -> 取出头部 -> 头部文件解密Hash -> 剩余内容Hash -> Hash对比
<br/>

5. ## **战斗--服务器校验**
   + 玩家战斗完,发送世界状态码,操作包
   + 世界状态码是数据的Hash值
   + 服务器校验完返回结果
   + 防止重复发包,初始位置可随机(随机值很大),会世界状态码随机
<br/>

6. ## **数据复查**
    + 校验的失败入库
    + 随机入库 -> 定时验算
    + 特定IP追踪 -> 封号
<br/>

------------------------
<span id='2'/>

## **2. 游戏体验**
* ## **战斗体验**
  + 位移滑步 -> 导出游戏里面使用的数据,每帧重新调
  + 打击震屏 -> 摄像机抖动
  + 慢放 -> 时间速度变慢
  + 镜头轨迹
  + 受击方反馈
    - 不同的攻击方式和技能造成不一样的受击效果
    - 骨骼抖动,打到受击点,抖动周围的骨骼
  + 击飞效果 -> 物理模拟
  + 击退曲线 -> 物理模拟
  + 精确打击点 -> 配合位移高低攻击,尽量做到不打击空气
<br/>

* ## **攻击特效**
  + 场景灯光
  + 人物灯光
  + 普通特效
  + 径向模糊
  + 粒子特效
  + 空气扭曲
  + 场景变色
<br/>

------------------------
<span id='3'/>

## **3. 粒子优化**
* ## **大面片换成多而小的面片**
1. 降低overdraw
2. 数量多表现效果更好
3. 但是顶点会增多 , 不过影响不大
<br/>

* ## **大量粒子模拟**
1. CPU+GPU Instancing (es3.0)
    + 模拟时,计算量多,CPU开销非常大,但是可以多线程优化(Job+Burst),手机不一定合适
2. Compute Shader (es3.1)
    + 利用GPU多核计算
    + 手机不一定兼容(但是现在大多数手机都是兼容的,只是SSBO不一定支持)
3. RenderTexture (es3.0)
    + 利用GPU的多核功能,但是绕开ComputeShader(es3.1)
    + RT内存开销,RT切换开销
    + 纹理采样消耗
    + 可能负优化
4. TFBO(Transform Feedback Buffer Object)
    + https://zhuanlan.zhihu.com/p/150570974
    + Unity GPU Skin 也用这套
    + 需要两个TFBO切换实现,一个Pass记录特效点,一个Pass把点变成面并染色
<br/>

* ## **粒子离线模拟**
&nbsp;&nbsp;详情见下面[4. 粒子离线模拟](#4)<br>
<br/>

------------------------
<span id='4'/>

## **4. 粒子离线模拟**
* ## **粒子离线模拟**
  1. 空间换时间
  2. 大多数的特效的播放时间短,0.1-2.0秒内,离线数据的内存可以接受
  3. 同一份离线数据,不同材质球,达到表现的效果不同
<br/>

* ## **离线方案一**
    ### 做法:
    + Vertex Animation Texture(顶点动作纹理)保存数据
    + Vertex Texture Fetch(VTF)还原效果
    ### 优势:
    + 存在DDC工具支持,可以直接利用生成
    ### 劣势:
    + VTF需要3.0
    + 贴图保存数据有限,且需要多次采样
    + 不能与计算包围盒,无效粒子难剔除
    + 失效粒子额外包体和内存浪费(数据对齐)
    + 贴图不能压缩
<br/>

* ## **离线方案二**
    ### 做法:
    + 记录坐标位置,把运动轨迹根据二阶贝塞尔曲线分成n个clip
    + 每个clip的位置运动轨迹,用二阶贝塞尔曲线控制(p0,p1,p2),可以存在位置容错
    + 把数据打包成mesh的a2v , 如:
      - 1.二阶贝塞尔曲线的控制点 POSITION,NORMAL,TANGENT
      - 2.速度强度 TANGENT.w
      - 3.偏移|旋转 TEXCOORD0.xy|zw
      - 4.速度|缩放 TEXCOORD1.xyz|w
      - 5.时间|Flag标记 TEXCOORD2.xy|z
      - 6.颜色 COLOR.xyzw
    + Vertex Shader还原数据达到效果
    ### 优势:
    + es2.0
    + 分段储存,可以剔除无效的粒子
    + 每段都有自己的AABB,可以剔除屏幕外的粒子
    ### 劣势:
    + 精度损耗
    + 内存消耗
<br/>
------------------------